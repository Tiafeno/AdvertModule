"use strict";app.controller("AdvertFormAddCtrl",function(a,b,c,d,e,f,g){a.activated=!1,a.searchTerm,a.clearSearchTerm=function(){a.searchTerm=""},e.find("input.demo-header-searchbox").on("keydown",function(a){a.stopPropagation()}),a.optionalInput={},a.imageGallery=[],a.Images=[],a.showHints=!0,a.Progress={Image:!1},a.imagePath=advert.assets_plugins_url+"img/washedout.png",a.advertPost={hidephone:!1},a.product_cat=[],a.$watch("advertPost",function(b,c,d){var e=Object.keys(a.optionalInput);if(0!==Object.keys(a.advertPost).length&&b.categorie!=c.categorie){_.each(e,function(b){a.optionalInput[b]=!1});var f=_.find(a.product_cat,function(a){return a.term_id==b.categorie}),g=_.findWhere(advert.products_cat_child,{name:f.name}).vendor;_.each(g,function(b,c){var d=_.find(advert.vendors,function(a){return b==a.id});a.optionalInput[d.validate]=!0})}},!0);var h=!1,i=function(a){return!!/(\.bmp|\.gif|\.jpg|\.jpeg|\.png)$/i.test(a)};a.range=function(a,b,c){c=c||1;for(var d=[],e=a;e<=b;e+=c)d.push(e);return d},a.uploadFile=function(){if(a.imageGallery.length==parseInt(d.atob("Mw==")))return f.error(d.atob("Tm9tYnJlIGxpbWl0ZSBkZXMgcGhvdG9zIGF0dGVpbnQ=")),!0;var b=event.target.files;if(void 0===b[0].name)return!0;if(!i(b[0].name))return f.error("File format invalid, please upload an jpg, jpeg, png, gif or bmp"),!0;var c=new FormData;angular.forEach(b,function(a,b){c.append("file",a)}),c.append("action","action_set_thumbnail_post"),c.append("post_id",advert.post_id),c.append("thumbnail_upload_nonce",angular.element("#thumbnail_upload_nonce").val()),a.Progress.Image=!0,a.$apply(),g.httpPostFormdata(c).then(function(b){var c=b.data;if(void 0!=b.status&&200==b.status)if(!0===c.type)h&&a.imageGallery.push({file:c.url,id:c.attach_id}),h||(h=!0),a.Images.push({file:c.url,id:c.attach_id});else{var d={};d.content=void 0===c.data?c:c.data,a.showDialog(d)}a.Progress.Image=!1},function(b){console.debug(b),a.Progress.Image=!1})},a.showDialog=function(a){void 0===a.title||a.title;f.alert(a.content,function(a){a.preventDefault(),f.success("You've clicked OK")})},a.setFormSubmit=function(b){if(b){var c=[],e=new FormData;a.activated=!0,a.imageGallery.forEach(function(a){c.push(a.id)}),a.advertPost.hidephone=1==a.advertPost.hidephone?1:0;var f=[];_.map(a.advertPost.attributs,function(b,c){a.optionalInput[c]&&f.push({value:b,_id:c})}),e.append("cost",a.advertPost.cost),e.append("title",a.advertPost.title),e.append("description",a.advertPost.description),e.append("state",a.advertPost.state),e.append("adress",a.advertPost.adress),e.append("phone",a.advertPost.phone),e.append("hidephone",a.advertPost.hidephone),e.append("gallery",JSON.stringify(c)),e.append("categorie",a.advertPost.categorie),e.append("attributs",angular.toJson(f)),e.append("action","action_add_new_advert"),e.append("post_id",advert.post_id),g.httpPostFormdata(e).then(function(b){if(0===parseInt(b))return a.activated=!1;a.activated=!1;var c=b.data;c.type&&(a.imageGallery=[],a.advertPost={},a.setAdvertForm.$setUntouched(),a.setAdvertForm.$setPristine()),d.setTimeout(function(){c.type&&a.$apply(function(){d.location.href=c.redirect_url})},2500)},function(b){a.activated=!1})}},a.onClicksetDefaultThumb=function(c,d){a.Progress.Image=!0,b({url:advert.ajax_url,method:"GET",params:{action:"action_set_thumbnail_id",attachment_id:parseInt(c),post_id:advert.post_id}}).then(function(b){b.data.type?(angular.element(".advert-pic").removeClass("active"),angular.element("#"+c).addClass("active")):console.warn(resp),a.Progress.Image=!1},function(){a.Progress.Image=!1})},a.onClickDeleteThumb=function(b){"number"==typeof b&&f.okBtn("Oui").cancelBtn("Non").confirm("Voulez vous vraiment effacer cette image?",function(c){c.preventDefault(),a.Progress.Image=!0;var d=new FormData;d.append("action","action_delete_post"),d.append("post_type","attachment"),d.append("id",b),g.httpPostFormdata(d).then(function(b){var c=b.data;if(!c.type)return console.warn(c),a.Progress.Image=!1;a.Images=_.reject(a.Images,function(a){return a.id===c.ID}),a.imageGallery=_.reject(a.imageGallery,function(a){return a.id===c.ID}),_.isEmpty(a.Images)&&_.isEmpty(a.imageGallery)&&(h=!1),angular.element("#fileInput").val(""),a.Progress.Image=!1},function(b){a.Progress.Image=!1,console.debug(b)})},function(a){a.preventDefault()})},this.Initialise=function(){g.getTermsProductCategory().then(function(b){b.data.forEach(function(b){if(1==b.term_id||"all"==b.slug)return!1;a.product_cat.push(b)})}).catch(function(){console.warn("Terms products error")})},this.Initialise()}).config(function(a,b){b.startSymbol("[[").endSymbol("]]"),a.theme("docs-dark","default").primaryPalette("yellow").dark()});